local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- // GLOBAL SETTINGS
getgenv().MagicBullet = false
getgenv().ShowFOV = true
getgenv().FOV = 371
getgenv().AimPart = "Head"
getgenv().WhitelistedFriend = ""

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

-- // สร้างวงกลม FOV ด้วย Drawing Library
local FOVCircle = Drawing.new("Circle")
FOVCircle.Thickness = 1
FOVCircle.Color = Color3.fromRGB(255, 255, 255) -- สีขาวตามรูป
FOVCircle.Transparency = 0.7
FOVCircle.Filled = false
FOVCircle.Visible = getgenv().ShowFOV
FOVCircle.Radius = getgenv().FOV

-- // ฟังก์ชันอัปเดตตำแหน่งวงกลม
RunService.RenderStepped:Connect(function()
    FOVCircle.Visible = getgenv().ShowFOV
    FOVCircle.Radius = getgenv().FOV
    FOVCircle.Position = Vector2.new(Mouse.X, Mouse.Y + 36) -- ปรับตำแหน่งให้ตรงกับปลายเมาส์
end)

-- // ฟังก์ชันหาเป้าหมาย
local function GetClosestTarget()
    local target = nil
    local dist = getgenv().FOV
    for _, v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer and v.Name ~= getgenv().WhitelistedFriend and v.Character and v.Character:FindFirstChild("Humanoid") and v.Character.Humanoid.Health > 0 then
            local pos, onScreen = Camera:WorldToScreenPoint(v.Character[getgenv().AimPart].Position)
            if onScreen then
                local magnitude = (Vector2.new(pos.X, pos.Y) - Vector2.new(Mouse.X, Mouse.Y)).Magnitude
                if magnitude < dist then
                    target = v.Character
                    dist = magnitude
                end
            end
        end
    end
    return target
end

-- // MAGIC BULLET LOGIC (Hooking)
local oldIndex
oldIndex = hookmetamethod(game, "__index", function(self, key)
    if getgenv().MagicBullet and not checkcaller() then
        if self == Mouse and (key == "Hit" or key == "Target") then
            local target = GetClosestTarget()
            if target then
                return (key == "Hit" and target[getgenv().AimPart].CFrame or target[getgenv().AimPart])
            end
        end
    end
    return oldIndex(self, key)
end)

-- // UI CREATION
local Window = Rayfield:CreateWindow({
    Name = "Hermanos'Dev | PVP",
    LoadingTitle = "Loading System...",
    LoadingSubtitle = "Blox Spin Version",
})

local CombatTab = Window:CreateTab("Combat", 4483362458)

-- // เมนูตามรูปที่คุณส่งมา
CombatTab:CreateToggle({
    Name = "Show FOV",
    CurrentValue = true,
    Callback = function(Value) getgenv().ShowFOV = Value end,
})

CombatTab:CreateSlider({
    Name = "FOV",
    Range = {0, 800},
    Increment = 1,
    CurrentValue = 371,
    Callback = function(Value) getgenv().FOV = Value end,
})

CombatTab:CreateDropdown({
    Name = "FOV Mode",
    Options = {"Middle", "Mouse"},
    CurrentOption = {"Middle"},
    Callback = function(Option) end,
})

CombatTab:CreateToggle({
    Name = "Magic Bullet",
    CurrentValue = false,
    Callback = function(Value) getgenv().MagicBullet = Value end,
})

CombatTab:CreateDropdown({
    Name = "Aim Part",
    Options = {"Head", "HumanoidRootPart"},
    CurrentOption = {"Head"},
    Callback = function(Option) getgenv().AimPart = Option[1] end,
})

-- // รายชื่อเพื่อน
local function GetFriendNames()
    local names = {"--"}
    for _, v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer then table.insert(names, v.Name) end
    end
    return names
end

local FriendDropdown = CombatTab:CreateDropdown({
    Name = "Friend List",
    Options = GetFriendNames(),
    CurrentOption = {"--"},
    Callback = function(Option) getgenv().WhitelistedFriend = Option[1] end,
})

CombatTab:CreateButton({
    Name = "Refresh Friend List",
    Callback = function() FriendDropdown:Refresh(GetFriendNames()) end,
})
